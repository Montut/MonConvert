<!DOCTYPE html>
<html lang="en">
<!-- === START: Updated <head> Section === -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- SEO Meta Tags -->
    <title>Montut Convert Tools - Free Online Video to MP4 Converter</title>
    <meta name="description" content="Easily convert WEBM, MOV, AVI, and other video formats to high-quality MP4 online for free with Montut Convert Tools. Secure, fast, and simple conversion.">
    <meta name="robots" content="index, follow"> <!-- Allow search engines to crawl and index -->
    <meta name="google-site-verification" content="8RYRvs2QcMKlrWuWhaBizLfal7Fc-cRjqIXHHQnBNNY" /> <!-- Google Search Console Verification -->

    <!-- Favicon -->
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <!-- Consider adding apple-touch-icon links as well for iOS devices -->
    <!-- <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"> -->

    <!-- Open Graph Meta Tags (for Facebook, LinkedIn, etc.) -->
    <meta property="og:title" content="Montut Convert Tools - Free Online Video to MP4 Converter">
    <meta property="og:description" content="Convert WEBM, MOV, AVI, and more to MP4 online. Fast, free, and secure video conversion.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://montutconverttools.com/">
    <!-- <meta property="og:image" content="https://montutconverttools.com/og-image.jpg"> --> <!-- Replace with your actual preview image URL -->
    <!-- <meta property="og:image:width" content="1200"> -->
    <!-- <meta property="og:image:height" content="630"> -->
    <meta property="og:site_name" content="Montut Convert Tools">

    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image"> <!-- Use 'summary' if you don't have a large image -->
    <meta name="twitter:title" content="Montut Convert Tools - Free Online Video to MP4 Converter">
    <meta name="twitter:description" content="Convert WEBM, MOV, AVI, and more to MP4 online. Fast, free, and secure video conversion.">
    <!-- <meta name="twitter:image" content="https://montutconverttools.com/twitter-image.jpg"> --> <!-- Replace with your actual Twitter preview image URL -->
    <!-- <meta name="twitter:site" content="@YourTwitterHandle"> --> <!-- Optional: Your Twitter handle -->

    <!-- Link to your CSS (assuming it's within the <style> tags for now) -->
    <style>
        /* Enhanced Styling (Keep existing styles here) */
        :root {
            --primary-color: #4a90e2; /* Softer Blue */
            --primary-hover: #357abd;
            --secondary-color: #f5a623; /* Accent Orange */
            --success-color: #7ed321; /* Bright Green */
            --success-hover: #68b318;
            --light-gray: #f8f9fa;
            --medium-gray: #e9ecef;
            --dark-gray: #6c757d;
            --text-color: #343a40;
            --white: #fff;
            --danger-color: #dc3545;
            --header-gradient: linear-gradient(135deg, #4a90e2 0%, #63a4ff 100%);
            --box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        }
        /* ... rest of your existing CSS ... */

        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-gray);
            margin: 0;
            color: var(--text-color);
            line-height: 1.6;
        }

        .page-header {
            background: var(--header-gradient);
            color: var(--white);
            padding: 40px 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .page-header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 600;
        }
        .page-header p {
            margin-top: 5px;
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            max-width: 1100px;
            margin: 40px auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 40px;
        }

        @media (min-width: 992px) {
            .main-content {
                grid-template-columns: 2fr 1fr; /* Main converter area and sidebar */
            }
        }

        .converter-section, .info-section, .stats-section, .how-to-section {
            background-color: var(--white);
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--box-shadow);
        }

        h2 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.6em;
            border-bottom: 2px solid var(--medium-gray);
            padding-bottom: 10px;
        }

        /* Converter Form Specific Styles */
        #uploadForm label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-gray);
            font-size: 0.95em;
        }

        input[type="file"], select {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid var(--medium-gray);
            border-radius: 6px;
            font-size: 1em;
            background-color: #fdfdfd;
        }
        input[type="file"] {
            border: 2px dashed var(--medium-gray);
            background-color: var(--light-gray);
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        input[type="file"]:hover {
            background-color: var(--medium-gray);
            border-color: var(--primary-color);
        }
        /* Style the file input button text */
        input[type="file"]::file-selector-button {
            background-color: var(--primary-color);
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
            margin-right: 10px; /* Space between button and text */
        }
        input[type="file"]::file-selector-button:hover {
            background-color: var(--primary-hover);
        }


        button#convertButton {
            background-color: var(--primary-color);
            color: white;
            padding: 14px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.1s ease;
            width: 100%;
            margin-top: 10px;
        }
        button#convertButton:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
        }
        button#convertButton:disabled {
            background-color: #bdc3c7; /* Disabled color */
            cursor: not-allowed;
            transform: none;
        }

        /* Status Area */
        #status {
            margin-top: 25px;
            padding: 15px;
            background-color: var(--light-gray);
            border-radius: 6px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-weight: 500;
            color: var(--dark-gray);
            border: 1px solid var(--medium-gray);
        }
        #status.status-error {
             color: var(--danger-color);
             border-color: var(--danger-color);
             background-color: #f8d7da;
        }
        #status.status-success {
             color: #155724; /* Darker green text */
             border-color: var(--success-color);
             background-color: #d4edda;
        }

        /* Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: var(--primary-color);
            animation: spin 1s linear infinite;
            display: none; /* Hidden initially */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Download Link */
        #downloadLink {
            display: none; /* Hidden initially */
            margin-top: 20px;
            padding: 14px 25px;
            background-color: var(--success-color);
            color: white;
            text-decoration: none;
            border-radius: 6px;
            transition: background-color 0.3s ease;
            font-size: 1.1em;
            font-weight: 600;
            text-align: center;
        }
        #downloadLink:hover {
            background-color: var(--success-hover);
        }

        /* Ad Placeholder */
        #ad-placeholder {
            margin-top: 25px;
            min-height: 90px;
            background-color: #eee;
            border: 1px dashed var(--medium-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--dark-gray);
            font-size: 0.9em;
            border-radius: 6px;
        }

        /* Progress Bar */
        progress#progressBar {
            width: 100%;
            margin-top: 15px;
            height: 10px;
            display: none; /* Hidden initially */
            border-radius: 5px;
            overflow: hidden; /* Ensures the fill respects the border radius */
        }
        /* Style the progress bar appearance */
        progress#progressBar::-webkit-progress-bar {
            background-color: var(--medium-gray);
            border-radius: 5px;
        }
        progress#progressBar::-webkit-progress-value {
            background-color: var(--primary-color);
            border-radius: 5px;
            transition: width 0.1s linear;
        }
        progress#progressBar::-moz-progress-bar { /* Firefox */
            background-color: var(--primary-color);
            border-radius: 5px;
            transition: width 0.1s linear;
        }

        /* Output Info Area */
        #outputInfo {
            margin-top: 15px;
            padding: 10px 15px;
            background-color: #e8f6f3; /* Light cyan */
            border-left: 4px solid #1abc9c; /* Teal */
            border-radius: 4px;
            font-size: 0.9em;
            display: none; /* Hidden initially */
            word-wrap: break-word;
        }
        #outputInfo strong {
            color: #16a085; /* Darker teal */
        }


        /* Remove Ad Placeholder CSS */
        /* #ad-placeholder { ... } */

        /* Info Section Styling */
        .features-list, .how-to-steps {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .features-list li, .how-to-steps li {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            font-size: 1.05em;
        }
        .features-list .icon, .how-to-steps .step-number {
            font-size: 1.5em;
            margin-right: 15px;
            color: var(--primary-color);
            flex-shrink: 0;
            width: 30px; /* Ensure alignment */
            text-align: center;
        }
         .how-to-steps .step-number {
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            font-weight: bold;
         }

        /* Stats Section */
        .stats-container {
            display: flex;
            justify-content: space-around;
            text-align: center;
            margin-top: 20px;
        }
        .stat-item .number {
            font-size: 2em;
            font-weight: 600;
            color: var(--secondary-color);
            display: block;
        }
        .stat-item .label {
            font-size: 0.9em;
            color: var(--dark-gray);
        }

        /* Footer */
        .page-footer {
            background-color: var(--text-color);
            color: var(--medium-gray);
            padding: 30px 20px;
            text-align: center;
            margin-top: 50px;
            font-size: 0.9em;
        }
        .page-footer a {
            color: var(--white);
            text-decoration: none;
            margin: 0 10px;
            transition: color 0.2s ease;
        }
        .page-footer a:hover {
            color: var(--primary-color);
            text-decoration: underline;
        }
        .page-footer p {
            margin-top: 15px;
            margin-bottom: 0;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .page-header h1 { font-size: 2em; }
            .main-content { grid-template-columns: 1fr; gap: 30px; margin-top: 30px;}
            .converter-section, .info-section, .stats-section, .how-to-section { padding: 20px; }
            h2 { font-size: 1.4em; }
            .stats-container { flex-direction: column; gap: 15px; }
        }

        /* Style for Privacy Disclaimer */
        .privacy-disclaimer {
            font-size: 0.85em;
            color: var(--dark-gray);
            background-color: var(--medium-gray);
            padding: 10px 15px;
            border-radius: 6px;
            margin-top: 20px;
            text-align: left;
            border-left: 4px solid var(--primary-color);
        }
        .privacy-disclaimer strong {
            color: var(--text-color);
        }

        /* Style for Donation Section */
        .donation-section {
            background-color: #fff3cd; /* Light yellow background */
            border: 1px solid #ffeeba;
            color: #856404; /* Dark yellow text */
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin: 30px auto 0 auto; /* Margin top, centered horizontally */
            max-width: 600px; /* Limit width */
        }
        .donation-section p {
            margin: 0 0 15px 0; /* Space below text */
            font-size: 1.05em;
        }
        .donation-button {
            display: inline-block;
            padding: 10px 20px;
            background-color: var(--secondary-color); /* Use accent color */
            color: var(--white);
            text-decoration: none;
            border-radius: 20px; /* Pill shape */
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.1s ease;
        }
        .donation-button:hover {
            background-color: #e69500; /* Darker orange */
            transform: scale(1.03);
        }
        .donation-button .icon {
            margin-right: 8px;
        }

    </style>
    <!-- Google AdSense Script -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5213336778723560"
         crossorigin="anonymous"></script>
    <!-- Load ffmpeg.wasm -->
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.0/dist/ffmpeg.min.js"></script>
</head>
<!-- === END: Updated <head> Section === -->
<body>

    <header class="page-header">
        <h1>Montut Convert Tools</h1>
        <p>Your simple, fast, and free solution for converting videos directly in your browser.</p>
    </header>

    <main class="main-content">
        <!-- Converter Area -->
        <section class="converter-section">
            <h2>Start Converting Now</h2>
            <form id="uploadForm" enctype="multipart/form-data">
                <!-- File Input -->
                <label for="videoFile">1. Choose Your Video File:</label>
                <input type="file" id="videoFile" name="videoFile" accept="video/*" required>

                <!-- Conversion Options -->
                <label for="compressionLevel">2. Select Compression Level:</label>
                <select id="compressionLevel" name="compressionLevel">
                    <option value="medium" selected>Medium (Recommended Balance)</option>
                    <option value="high">High (Smaller File Size)</option>
                    <option value="low">Low (Best Possible Quality)</option>
                </select>

                <label for="outputResolution">3. Choose Output Resolution:</label>
                <select id="outputResolution" name="outputResolution">
                    <option value="original" selected>Keep Original Resolution</option>
                    <option value="1080p">1080p (Full HD)</option>
                    <option value="720p">720p (HD)</option>
                    <option value="480p">480p (Standard Definition)</option>
                </select>

                <!-- Output Format Selection -->
                <label for="outputFormat">4. Choose Output Format:</label>
                <select id="outputFormat" name="outputFormat">
                    <option value="mp4" selected>MP4 (Video)</option>
                    <option value="gif">GIF (Animated Image)</option>
                </select>

                <!-- Submit Button -->
                <button type="button" id="convertButton">🚀 Convert Now</button> <!-- Changed type to button -->
            </form>

            <!-- === START: Privacy Disclaimer === -->
            <div class="privacy-disclaimer">
                <strong>Privacy Note:</strong> Your files are processed <strong>entirely within your browser</strong> using WebAssembly. They are <strong>never uploaded</strong> to our servers, ensuring maximum privacy.
            </div>
            <!-- === END: Privacy Disclaimer === -->

            <!-- Status Display Area -->
            <div id="status">
                <div class="spinner" id="spinner"></div>
                <span id="statusText">Loading converter... Please wait.</span>
            </div>

            <!-- Progress Bar -->
            <progress id="progressBar" value="0" max="100"></progress>

            <!-- Output Info Area -->
            <div id="outputInfo"></div>

            <!-- Download Link Area -->
            <a id="downloadLink" href="#" download>⬇️ Download Converted File</a>
        </section>

        <!-- Sidebar / Info Area -->
        <aside class="sidebar">
            <!-- Features Section -->
            <section class="info-section">
                <h2>Why Choose Us?</h2>
                <ul class="features-list">
                    <li><span class="icon">🔒</span> 100% Private (Conversion happens in your browser, no uploads!)</li>
                    <li><span class="icon">⚡</span> Fast Client-Side Processing</li>
                    <li><span class="icon">✨</span> High-Quality MP4 & GIF Output</li>
                    <li><span class="icon">⚙️</span> Customizable Settings (Quality/Resolution)</li>
                    <li><span class="icon">📱</span> Mobile Friendly Design</li>
                    <li><span class="icon">📶</span> Works Offline (After first load)</li>
                </ul>
            </section>

            <!-- Mock Stats Section -->
            <section class="stats-section">
                 <h2>Our Achievements</h2>
                 <div class="stats-container">
                     <div class="stat-item">
                         <span class="number">1M+</span>
                         <span class="label">Files Converted</span>
                     </div>
                     <div class="stat-item">
                         <span class="number">50K+</span>
                         <span class="label">Happy Users</span>
                     </div>
                     <div class="stat-item">
                         <span class="number">99%</span>
                         <span class="label">Uptime</span>
                     </div>
                 </div>
            </section>

            <!-- How It Works Section -->
            <section class="how-to-section">
                <h2>How It Works (Client-Side)</h2>
                <ol class="how-to-steps">
                    <li><span class="step-number">1</span> Choose your video file.</li>
                    <li><span class="step-number">2</span> Select quality & format options.</li>
                    <li><span class="step-number">3</span> Click "Convert Now".</li>
                    <li><span class="step-number">4</span> Wait for browser processing.</li>
                    <li><span class="step-number">5</span> Download your converted file!</li>
                </ol>
            </section>
        </aside>
    </main>

    <!-- === START: Donation Section === -->
    <section class="donation-section">
        <p>Enjoy using Montut Convert Tools? Support future development and keep the servers running!</p>
        <a href="https://buymeacoffee.com/montut" target="_blank" rel="noopener noreferrer" class="donation-button">
            <span class="icon">☕</span> Buy Me a Coffee
        </a>
    </section>
    <!-- === END: Donation Section === -->

    <footer class="page-footer">
        <a href="#privacy">Privacy Policy</a> |
        <a href="#terms">Terms of Service</a> |
        <a href="#contact">Contact Us</a>
        <p>&copy; 2025 Montut Convert Tools. All rights reserved.</p>
    </footer>

    <script>
        const { createFFmpeg, fetchFile } = FFmpeg; // Destructure from FFmpeg loaded via CDN
        let ffmpeg; // Keep ffmpeg instance reusable
        let isFFmpegLoaded = false;

        // DOM Elements
        const videoFileInput = document.getElementById('videoFile');
        const compressionLevelSelect = document.getElementById('compressionLevel');
        const outputResolutionSelect = document.getElementById('outputResolution');
        const outputFormatSelect = document.getElementById('outputFormat');
        const convertButton = document.getElementById('convertButton');
        const statusDiv = document.getElementById('status');
        const statusText = document.getElementById('statusText');
        const spinner = document.getElementById('spinner');
        const progressBar = document.getElementById('progressBar');
        const outputInfoDiv = document.getElementById('outputInfo');
        const downloadLink = document.getElementById('downloadLink');

        // --- Helper Functions ---

        // Function to update status display
        function updateStatus(message, showSpinner = false, statusType = 'info') {
            statusText.textContent = message;
            spinner.style.display = showSpinner ? 'inline-block' : 'none';
            statusDiv.classList.remove('status-success', 'status-error'); // Reset classes
            if (statusType === 'success') {
                statusDiv.classList.add('status-success');
            } else if (statusType === 'error') {
                statusDiv.classList.add('status-error');
            }
            // 'info' uses default styling
            console.log(`Status (${statusType}): ${message}`); // Console log for debugging
        }

        // Function to initialize FFmpeg instance
        const initializeFFmpeg = async () => {
            if (!ffmpeg) {
                console.log("Creating FFmpeg instance...");
                ffmpeg = createFFmpeg({
                    log: true, // Enable ffmpeg logging in console
                    corePath: 'https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js',
                });
            }
            if (!ffmpeg.isLoaded()) {
                updateStatus('Loading converter core... (First load may take a moment)', true, 'info');
                progressBar.style.display = 'none';
                try {
                    await ffmpeg.load();
                    isFFmpegLoaded = true;
                    updateStatus('Converter ready. Select file and options.', false, 'success');
                    convertButton.disabled = false; // Enable button once loaded
                } catch (error) {
                    console.error("Error loading ffmpeg:", error);
                    updateStatus(`Error loading converter: ${error.message}. Try refreshing or use a different browser.`, false, 'error');
                    isFFmpegLoaded = false;
                    convertButton.disabled = true; // Keep disabled if load fails
                    throw error;
                }
            } else {
                 updateStatus('Converter ready. Select file and options.', false, 'success');
                 convertButton.disabled = false;
            }
        };

        // --- Event Listeners ---

        // Initialize FFmpeg on page load
        document.addEventListener('DOMContentLoaded', async () => {
            convertButton.disabled = true; // Disable button initially
            await initializeFFmpeg();

             // Check for SharedArrayBuffer support
            if (typeof SharedArrayBuffer === 'undefined') {
                console.warn("SharedArrayBuffer is not available. FFmpeg.wasm performance might be limited or it might not work.");
                updateStatus('Warning: Your browser might lack features for optimal performance (SharedArrayBuffer). Conversion might be slow or fail.', false, 'error');
                // Keep button enabled if ffmpeg loaded, but warn user
                if(isFFmpegLoaded) convertButton.disabled = false;
            }
        });

        // Conversion logic on button click
        convertButton.addEventListener('click', async () => {
            const file = videoFileInput.files[0];
            const outputFormat = outputFormatSelect.value;
            const compression = compressionLevelSelect.value;
            const resolution = outputResolutionSelect.value;

            if (!file) {
                updateStatus('Please select a video file first.', false, 'error');
                return;
            }
            if (!isFFmpegLoaded) {
                 updateStatus('Converter core not loaded. Please wait or refresh.', false, 'error');
                 return;
            }

            convertButton.disabled = true;
            convertButton.innerHTML = 'Processing...';
            downloadLink.style.display = 'none';
            outputInfoDiv.style.display = 'none';
            progressBar.style.display = 'none';
            progressBar.value = 0;

            try {
                // 1. Load file into ffmpeg's virtual file system
                updateStatus(`Loading file "${file.name}"...`, true, 'info');
                const inputFileName = `input.${file.name.split('.').pop() || 'vid'}`;
                const outputFileName = `output.${outputFormat}`;
                let fileData;
                try {
                    fileData = await fetchFile(file);
                    ffmpeg.FS('writeFile', inputFileName, fileData);
                } catch (error) {
                    console.error("Error reading file:", error);
                    throw new Error(`Failed to read input file: ${error.message}`);
                }

                // 2. Setup Progress Handler
                ffmpeg.setProgress(({ ratio }) => {
                    if (ratio >= 0 && ratio <= 1) {
                        progressBar.style.display = 'block';
                        progressBar.value = ratio * 100;
                        updateStatus(`Converting... ${Math.round(ratio * 100)}%`, true, 'info');
                    } else {
                        progressBar.style.display = 'none'; // Hide if ratio is invalid
                    }
                });

                // 3. Construct and run the FFmpeg command
                updateStatus('Starting conversion... (This can take time)', true, 'info');
                const startTime = performance.now();

                let command = ['-i', inputFileName];

                // --- Add MP4 specific options ---
                if (outputFormat === 'mp4') {
                    // Compression (CRF)
                    if (compression === 'low') command.push('-crf', '18');
                    else if (compression === 'high') command.push('-crf', '28');
                    else command.push('-crf', '23'); // Medium default

                    // Resolution Scaling (only if not 'original')
                    if (resolution === '1080p') command.push('-vf', 'scale=-2:1080');
                    else if (resolution === '720p') command.push('-vf', 'scale=-2:720');
                    else if (resolution === '480p') command.push('-vf', 'scale=-2:480');

                    // Standard MP4 options
                    command.push(
                        '-c:v', 'libx264',
                        '-preset', 'ultrafast', // Faster encoding in browser
                        '-c:a', 'aac',
                        '-b:a', '128k',
                        '-movflags', '+faststart'
                    );
                }
                // --- Add GIF specific options ---
                else if (outputFormat === 'gif') {
                    let vfOptions = ['fps=15']; // Default fps for GIF
                    // Apply scaling for GIF based on resolution dropdown
                    if (resolution === '1080p') vfOptions.push('scale=-2:1080');
                    else if (resolution === '720p') vfOptions.push('scale=-2:720');
                    else if (resolution === '480p') vfOptions.push('scale=-2:480');
                    else vfOptions.push('scale=480:-1'); // Default scale if original/other

                    vfOptions.push('flags=lanczos');
                    command.push('-vf', vfOptions.join(','));
                    command.push('-c:v', 'gif');
                    updateStatus('Starting GIF conversion... (May be slow)', true, 'info');
                } else {
                    throw new Error("Unsupported output format.");
                }

                command.push(outputFileName); // Add output file name

                console.log("Running FFmpeg command:", command.join(' '));
                await ffmpeg.run(...command);

                const endTime = performance.now();
                const duration = ((endTime - startTime) / 1000).toFixed(2);

                // 4. Read the result
                updateStatus('Conversion finished. Preparing download...', false, 'success');
                progressBar.style.display = 'none';
                const data = ffmpeg.FS('readFile', outputFileName);

                // 5. Create download link
                const blob = new Blob([data.buffer], { type: outputFormat === 'mp4' ? 'video/mp4' : 'image/gif' });
                const url = URL.createObjectURL(blob);

                downloadLink.href = url;
                downloadLink.download = outputFileName;
                downloadLink.style.display = 'block';

                // 6. Display output info
                const outputFileSize = (blob.size / 1024 / 1024).toFixed(2);
                outputInfoDiv.innerHTML = `
                    <strong>Conversion Details:</strong><br>
                    Original File: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)<br>
                    Output File: ${outputFileName} (${outputFileSize} MB)<br>
                    Conversion Time: ${duration} seconds
                `;
                outputInfoDiv.style.display = 'block';
                updateStatus('Done! Click the link below to download.', false, 'success');

                // 7. Cleanup virtual file system
                try {
                    ffmpeg.FS('unlink', inputFileName);
                    ffmpeg.FS('unlink', outputFileName);
                } catch (e) {
                    console.warn("Could not unlink files.", e);
                }

            } catch (error) {
                console.error('Conversion Error:', error);
                updateStatus(`Error: ${error.message}. Check console for details.`, false, 'error');
                progressBar.style.display = 'none';
            } finally {
                convertButton.disabled = false;
                convertButton.innerHTML = '🚀 Convert Now';
                // Ensure progress handler is removed or reset if necessary,
                // though re-assigning it on next run should be fine.
                ffmpeg.setProgress(() => {}); // Clear progress handler
            }
        });

        // Reset status when a new file is selected
        videoFileInput.addEventListener('change', () => {
            if (isFFmpegLoaded) {
                updateStatus('Ready to convert.', false, 'success');
            } else {
                 updateStatus('Converter core loading or failed. Please wait or refresh.', false, 'error');
            }
            downloadLink.style.display = 'none';
            outputInfoDiv.style.display = 'none';
            progressBar.style.display = 'none';
            progressBar.value = 0;
            // Keep button disabled until ffmpeg is loaded
            convertButton.disabled = !isFFmpegLoaded;
            convertButton.innerHTML = '🚀 Convert Now';
        });

    </script>

</body>
</html>
